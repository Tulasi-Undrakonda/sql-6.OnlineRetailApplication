USE OnlineRetailApplication;

-- SUBQUERIES & NESTED QUERIES  

/* ============================================================
   SUBQUERIES IN SELECT (SCALAR SUBQUERIES)
   ============================================================ */
-- 1. Total orders placed by each customer
SELECT 
    c.customer_id,
    c.first_name,
    (SELECT COUNT(*) FROM orders o 
     WHERE o.customer_id = c.customer_id) AS total_orders
FROM customers c;

-- 2. Total amount spent by each customer
SELECT 
    c.customer_id,
    (SELECT SUM(total_amount) FROM orders o
     WHERE o.customer_id = c.customer_id) AS total_spent
FROM customers c;

-- 3. Average product price for each category
SELECT 
    cat.category_id,
    cat.category_name,
    (SELECT AVG(price) 
     FROM products p 
     WHERE p.category_id = cat.category_id) AS avg_price
FROM categories cat;

/* ============================================================
   SUBQUERIES IN WHERE CLAUSE
   ============================================================ */
-- 4. Customers who made payments
SELECT *
FROM customers
WHERE customer_id IN (SELECT customer_id FROM payments);

-- 5. Orders with total above average order value
SELECT *
FROM orders
WHERE total_amount > (SELECT AVG(total_amount) FROM orders);

-- 6. Products that received at least one review
SELECT *
FROM products
WHERE product_id IN (SELECT product_id FROM reviews);

/* ============================================================
   SUBQUERIES IN FROM CLAUSE (DERIVED TABLES)
   ============================================================ */
-- 7. Top categories by product count
SELECT c.category_name, t.product_count
FROM categories c
JOIN (
    SELECT category_id, COUNT(*) AS product_count
    FROM products
    GROUP BY category_id
) t ON c.category_id = t.category_id;

-- 8. Customer spending summary
SELECT c.first_name, c.last_name, s.total_spent
FROM customers c
JOIN (
    SELECT customer_id, SUM(total_amount) AS total_spent
    FROM orders
    GROUP BY customer_id
) s ON c.customer_id = s.customer_id;

-- 9. Product-wise total quantity sold
SELECT p.product_name, x.total_qty_sold
FROM products p
JOIN (
    SELECT product_id, SUM(quantity) AS total_qty_sold
    FROM order_items
    GROUP BY product_id
) x ON p.product_id = x.product_id;

/* ============================================================
    CORRELATED SUBQUERIES
   ============================================================ */

-- 10. Products priced above their category average
SELECT *
FROM products p1
WHERE price > (
    SELECT AVG(price)
    FROM products p2
    WHERE p1.category_id = p2.category_id
);

-- 11. Customers whose order count is above the average count per customer
SELECT *
FROM customers c
WHERE (
    SELECT COUNT(*) FROM orders o WHERE o.customer_id = c.customer_id
) > (
    SELECT AVG(order_count)
    FROM (SELECT customer_id, COUNT(*) AS order_count FROM orders GROUP BY customer_id) x
);

-- 12. Reviews higher than the product's average rating
SELECT *
FROM reviews r1
WHERE r1.rating = (
    SELECT AVG(r2.rating)
    FROM reviews r2
    WHERE r2.product_id = r1.product_id
);



/* ============================================================
   SUBQUERIES USING IN
   ============================================================ */

-- 13. Customers who purchased electronics category products
SELECT *
FROM customers
WHERE customer_id IN (
    SELECT o.customer_id
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    JOIN products p ON p.product_id = oi.product_id
    JOIN categories c ON c.category_id = p.category_id
    WHERE c.category_name = 'Electronics'
);

-- 14. Products reviewed by customers from Mumbai
SELECT *
FROM products
WHERE product_id IN (
    SELECT product_id
    FROM reviews
    WHERE customer_id IN (
        SELECT customer_id FROM customers WHERE city = 'Mumbai'
    )
);

-- 15. Orders that contain items priced > $100
SELECT *
FROM orders
WHERE order_id IN (
    SELECT order_id
    FROM order_items oi
    JOIN products p ON oi.product_id = p.product_id
    WHERE p.price > 100
);



/* ============================================================
   SUBQUERIES USING EXISTS
   ============================================================ */

-- 16. Customers who placed at least one order
SELECT *
FROM customers c
WHERE EXISTS (
    SELECT 1 FROM orders o WHERE o.customer_id = c.customer_id
);

-- 17. Products that have been ordered
SELECT *
FROM products p
WHERE EXISTS (
    SELECT 1 FROM order_items oi WHERE oi.product_id = p.product_id
);

-- 18. Orders with successful payment
SELECT *
FROM orders o
WHERE EXISTS (
    SELECT 1 
    FROM payments p
    WHERE p.order_id = o.order_id AND p.status = 'Completed'
);



/* ============================================================
   SUBQUERIES USING '=' (SINGLE VALUE MATCH)
   ============================================================ */

-- 19. Highest rated product
SELECT *
FROM products
WHERE product_id = (
    SELECT product_id
    FROM reviews
    GROUP BY product_id
    ORDER BY AVG(rating) DESC
    LIMIT 1
);

-- 20. Customer who made the highest payment
SELECT *
FROM customers
WHERE customer_id = (
    SELECT customer_id
    FROM payments
    ORDER BY amount DESC
    LIMIT 1
);

-- 21. Category with maximum number of products
SELECT *
FROM categories
WHERE category_id = (
    SELECT category_id
    FROM products
    GROUP BY category_id
    ORDER BY COUNT(*) DESC
    LIMIT 1
);



/* ============================================================
   MULTI-LEVEL NESTED SUBQUERIES
   ============================================================ */

-- 22. Customers who bought the most expensive product
SELECT *
FROM customers
WHERE customer_id IN (
    SELECT o.customer_id
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    WHERE oi.product_id = (
        SELECT product_id
        FROM products
        ORDER BY price DESC
        LIMIT 1
    )
);

-- 23. Products reviewed by customers who paid more than average
SELECT *
FROM products
WHERE product_id IN (
    SELECT product_id 
    FROM reviews 
    WHERE customer_id IN (
        SELECT customer_id 
        FROM payments 
        GROUP BY customer_id 
        HAVING SUM(amount) > (SELECT AVG(amount) FROM payments)
    )
);

-- 24. Categories of products purchased in orders with successful payment
SELECT DISTINCT category_name
FROM categories
WHERE category_id IN (
    SELECT p.category_id
    FROM products p
    WHERE p.product_id IN (
        SELECT oi.product_id
        FROM order_items oi
        WHERE oi.order_id IN (
            SELECT order_id FROM payments WHERE status = 'Completed'
        )
    )
);
